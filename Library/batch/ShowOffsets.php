<?php

/**
 * Count offsets.
 *
 * This file contains a script to count the unit offset occurrences.
 *
 *	@package	OntologyWrapper
 *	@subpackage	Test
 *
 *	@author		Milko A. Škofič <m.skofic@cgiar.org>
 *	@version	1.00 19/01/2015
 */

/*=======================================================================================
 *																						*
 *									ShowOffsets.php										*
 *																						*
 *======================================================================================*/

//
// Global includes.
//
require_once( 'includes.inc.php' );

//
// local includes.
//
require_once( 'local.inc.php' );

//
// Session definitions.
//
require_once( kPATH_DEFINITIONS_ROOT."/Session.inc.php" );

//
// Tag definitions.
//
require_once( kPATH_DEFINITIONS_ROOT."/Tags.inc.php" );


/*=======================================================================================
 *	DATA																				*
 *======================================================================================*/

//
// Offsets list.
//
$offsets = array(
	'@bc' => 2579115,
	'@17f' => 2536207,
	'@d' => 2412399,
	'@c1' => 2388516,
	'@690' => 2375714,
	'@691' => 2375714,
	'@873.@c7' => 1958217,
	'@874.@6a2' => 1874775,
	'@874.@6a3' => 1829835,
	'@13d' => 1801914,
	'@12f' => 1801383,
	'@13f' => 1711649,
	'@135' => 1711649,
	'@875.@69e' => 1697720,
	'@144' => 1658107,
	'@c0' => 1644649,
	'@bf' => 1644649,
	'@136' => 1477667,
	'@692' => 1448658,
	'@874.@693' => 1185176,
	'@c3' => 1165082,
	'@150' => 1151339,
	'@151' => 1143603,
	'@152' => 1143603,
	'@876.@6a8' => 1117091,
	'@17a' => 1114720,
	'@874.@6aa' => 981280,
	'@180.@17f' => 976848,
	'@873.@cd' => 771176,
	'@873.@695' => 728123,
	'@873.@694' => 694515,
	'@874.@182.@c2' => 687851,
	'@874.@182.@6a5' => 687851,
	'@873.@f3' => 678891,
	'@873.@fa' => 677526,
	'@158' => 628546,
	'@180.@691' => 605681,
	'@180.@c1' => 605214,
	'@146' => 592043,
	'@875.@69d' => 584773,
	'@10e' => 580751,
	'@140' => 570687,
	'@873.@e9' => 530750,
	'@875.@c1' => 526112,
	'@875.@69f' => 526112,
	'@180.@690' => 525660,
	'@129' => 523313,
	'@873.@f4' => 502840,
	'@873.@fb' => 502392,
	'@873.@1a0.@2e' => 475436,
	'@875.@6a1' => 461880,
	'@873.@101' => 453029,	
	'@873.@1a0.@c1' => 450204,
	'@873.@1a0.@696' => 450204,
	'@872.@69c' => 381802,
	'@873.@1a0.@697' => 374365,
	'@186.@2e' => 340478,
	'@186.@18b' => 340466,
	'@186.@75' => 340424,
	'@186.@188' => 339486,
	'@186.@79' => 339316,	
	'@6ab' => 250480,
	'@141' => 247890,
	'@876.@6a9' => 224109,
	'@873.@ca' => 219814,
	'@875.@2e' => 194629,
	'@186.@c1' => 187043,
	'@875.@6a0' => 184916,
	'@c7' => 182732,
	'@186.@7c' => 166878,
	'@18f' => 162082,
	'@198' => 161520,
	'@18e' => 161520,
	'@19c' => 160492,
	'@197' => 160492,
	'@1a0.@2e' => 160191,
	'@1a0.@697' => 160189,
	'@873.@f9' => 159732,
	'@fa' => 155895,
	'@f3' => 155894,
	'@1a0.@79' => 150925,
	'@1a0.@c1' => 150499,
	'@1a0.@696' => 150499,
	'@695' => 145044,
	'@69e' => 144721,
	'@694' => 144586,
	'@874.@181' => 140388,
	'@186.@189' => 128680,
	'@873.@1a0.@75' => 126135,
	'@873.@1a0.@79' => 123669,
	'@873.@1a0.@7c' => 121815,
	'@cd' => 120838,
	'@873.@104' => 112918,
	'@873.@108' => 112541,
	'@873.@107' => 112541,
	'@1a0.@7a' => 111040,
	'@874.@6a4' => 109189,
	'@874.@182.@6a6' => 104267,
	'@872.@1a4.@2e' => 99700,
	'@872.@1a4.@69b' => 99691,
	'@875.@79' => 94111,
	'@e9' => 90731,
	'@872.@c7' => 90691,
	'@873.@103' => 89422,
	'@873.@102' => 89164,
	'@873.@cb' => 85701,
	'@f4' => 84914,
	'@fb' => 83761,
	'@873.@100' => 82586,
	'@873.@109' => 81431,
	'@ca' => 79385,
	'@873.@cc' => 70171,
	'@cb' => 69726,
	'@872.@1a4.@69a' => 69571,
	'@872.@1a4.@c1' => 69571,
	'@105' => 67423,
	'@106' => 63313,
	'@cc' => 51844,
	'@69d' => 48755,
	'@101' => 47103,
	'@873.@1a0.@7d' => 46489,
	'@1a0.@d' => 26766,
	'@1a0.@83' => 26766,
	'@1a0.@7c' => 26766,
	'@875.@7c' => 26115,
	'@1a0.@e9' => 21246,
	'@2e' => 21220,
	'@7c' => 20658,
	'@1a0.@32' => 20091,
	'@1a0.@7b' => 17641,
	'@1a0.@7f' => 16480,
	'@873.@10b' => 14956,
	'@79' => 14569,
	'@7b' => 13064,
	'@6cd' => 12844,
	'@6c6' => 12801,
	'@1a0.@80' => 12769,
	'@1a2' => 11078,
	'@7f' => 10843,
	'@142' => 8551,
	'@10d' => 8490,
	'@6ce' => 8212,
	'@6cf' => 7599,
	'@1a0.@7d' => 7501,
	'@7a' => 7455,
	'@186.@7d' => 7216,
	'@80' => 6892,
	'@7d' => 4879,
	'@104' => 4595,
	'@6d3' => 4589,
	'@155' => 4589,
	'@15a' => 4589,
	'@156' => 4589,
	'@168' => 4450,
	'@16e.@b2' => 4024,
	'@7e' => 3896,
	'@180.@32' => 3662,
	'@ea' => 3227,
	'@6b2' => 3227,
	'@6af' => 3227,
	'@ed' => 3227,
	'@6ad' => 3227,
	'@6ac' => 3227,
	'@6ae' => 3227,
	'@6b1' => 3227,
	'@10c' => 3227,
	'@6b5' => 3224,
	'@6b6.@6c4' => 3198,
	'@6b6.@6c0' => 3198,
	'@6b6.@13f' => 3198,
	'@6b6.@135' => 3198,
	'@6b6.@6bb' => 3198,
	'@6b6.@6bc' => 3198,
	'@6b6.@6bf' => 3198,
	'@6b6.@13d' => 3198,
	'@6b6.@12f' => 3198,
	'@6b6.@6b9' => 3198,
	'@6b0' => 3194,
	'@eb' => 3182,
	'@1a0.@81' => 3017,
	'@6b6.@6be' => 3012,
	'@fd' => 2625,
	'@ff' => 2625,
	'@fc' => 2625,
	'@f6' => 2621,
	'@f5' => 2621,
	'@f8' => 2621,
	'@167.@c8' => 2521,
	'@15b' => 2488,
	'@15c' => 2488,
	'@6b6.@6bd' => 2394,
	'@167.@168' => 2377,
	'@6b6.@6c3' => 2283,
	'@6d1' => 2122,
	'@16e.@16f' => 2122,
	'@6b6.@6ba' => 1968,
	'@167.@c9' => 1875,
	'@1a0.@7e' => 1743,
	'@6b6.@6c2' => 1667,
	'@1a0.@fb' => 1597,
	'@1a0.@f4' => 1597,
	'@6b6.@6b8' => 1560,
	'@6b6.@6b7' => 1559,
	'@14b' => 1552,
	'@148' => 1509,
	'@12b' => 1449,
	'@12d' => 1365,
	'@186.@18a' => 1231,
	'@84' => 1122,
	'@6b4' => 1121,
	'@132' => 1098,
	'@16e.@aa' => 1042,
	'@19a' => 1028,
	'@199' => 1028,
	'@c8' => 1025,
	'@149' => 1012,
	'@186.@13d' => 992,
	'@1a0.@77' => 979,
	'@1a0.@76' => 975,
	'@186.@18d' => 971,
	'@16e.@c9' => 930,
	'@180.@d' => 878,
	'@180.@7c' => 878,
	'@180.@83' => 878,
	'@186.@7a' => 877,
	'@12e' => 839,
	'@16e.@c7' => 818,
	'@180.@7b' => 711,
	'@167.@c7' => 646,
	'@16e.@173' => 613,
	'@16e.@172' => 613,
	'@16e.@171' => 613,
	'@1a6.@1a7' => 613,
	'@190' => 562,
	'@191' => 562,
	'@192' => 562,
	'@180.@7f' => 553,
	'@14a' => 548,
	'@6b6.@6c5' => 510,
	'@180.@e9' => 496,
	'@19e.@13d' => 489,
	'@19e.@13f' => 488,
	'@19e.@12f' => 488,
	'@6b3' => 418,
	'@873.@c8' => 391,
	'@194.@c8' => 300,
	'@194.@19a' => 300,
	'@194.@199' => 300,
	'@194.@198' => 300,
	'@194.@197' => 300,
	'@180.@80' => 264,
	'@14c' => 261,
	'@16e.@174' => 254,
	'@186.@83' => 237,
	'@186.@d' => 237,
	'@159' => 221,
	'@186.@e9' => 217,
	'@157' => 212,
	'@147' => 205,
	'@13e' => 201,
	'@167.@169' => 178,
	'@180.@81' => 159,
	'@16e.@177' => 148,
	'@16e.@175' => 148,
	'@16e.@176' => 148,
	'@186.@7b' => 147,
	'@186.@7f' => 144,
	'@6b6.@6c1' => 137,
	'@16e.@ac' => 132,
	'@186.@80' => 106,
	'@180.@7d' => 104,
	'@873.@10a' => 99,
	'@180.@fb' => 84,
	'@180.@f4' => 84,
	'@6b6.@152' => 84,
	'@6b6.@151' => 84,
	'@6b6.@150' => 84,
	'@186.@81' => 82,
	'@167.@16a' => 58,
	'@16e.@170' => 53,
	'@14d' => 50,
	'@186.@18c' => 37,
	'@186.@32' => 37,
	'@167.@15d' => 33,
	'@167.@15e' => 33,
	'@186.@fb' => 29,
	'@186.@f4' => 29,
	'@6c8' => 20,
	'@6b6.@17a' => 19,
	'@186.@7e' => 19,
	'@17b' => 7,
	'@851.@852' => 2,
	'@851.@84d' => 2,
	'@851.@84c' => 2,
	'@842' => 2,
	'@851.@84b' => 2,
	'@843' => 2,
	'@851.@849' => 2,
	'@1a6.@1ab' => 2,
	'@1a6.@1a8' => 2,
	'@1a6.@1a9' => 2,
	'@851.@84a' => 2,
	'@841' => 2,
	'@1a6.@1aa' => 2,
	'@851.@84e' => 2,
	'@851.@848' => 2,
	'@845' => 1
);

/*=======================================================================================
 *	TEST																				*
 *======================================================================================*/

//
// MAIN.
//
try
{
	//
	// Check arguments.
	//
	if( $argc < 2 )
		exit( "usage: php -f ShowOffsets.php "
			 ."<database>\n" );														// ==>
	
	//
	// Get arguments.
	//
	$database = $argv[ 1 ];
	
	//
	// Parse database.
	//
	$parts = parse_url( $database );
	
	//
	// Inform.
	//
	echo( "\n"
		 ."Host:             ".$parts[ 'host' ]."\n"
		 ."Port:             ".$parts[ 'port' ]."\n"
		 ."Database:         ".substr( $parts[ 'path' ], 1 )."\n"
		 ."\n" );
	
	//
	// Instantiate data dictionary.
	//
	$wrapper
		= new OntologyWrapper\Wrapper(
			kSESSION_DDICT,
			array( array( 'localhost', 11211 ) ) );

	//
	// Set databases.
	//
	$meta = $wrapper->metadata(
		new OntologyWrapper\MongoDatabase( $database ) );
	$wrapper->users(
		new OntologyWrapper\MongoDatabase( $database ) );
	$wrapper->units(
		new OntologyWrapper\MongoDatabase( $database ) );

	//
	// Load data dictionary.
	//
	if( ! $wrapper->dictionaryFilled() )
		$wrapper->loadTagCache();
	
	//
	// Resolve collection.
	//
	$collection
		= $wrapper->resolveCollection(
			OntologyWrapper\UnitObject::kSEQ_NAME );
	
	//
	// Build results table.
	//
	$results = Array();
	foreach( $offsets as $key => $value )
	{
		//
		// Extract path.
		//
		$path = explode( '.', $key );
		$tag = array_pop( $path );
		
		//
		// Set tag.
		//
		$results[ $key ]
			= array(
				'Tag' =>
					$wrapper->resolveCollection(
						OntologyWrapper\Tag::kSEQ_NAME )
							->matchOne( array( kTAG_ID_HASH => $tag ), kQUERY_OBJECT )
								->offsetGet( kTAG_NID ) );
		
		//
		// Set path.
		//
		if( count( $path ) )
		{
			foreach( array_keys( $path ) as $index )
				$path[ $index ]
					= $wrapper->resolveCollection(
						OntologyWrapper\Tag::kSEQ_NAME )
							->matchOne( array( kTAG_ID_HASH => $path[ $index ] ),
										kQUERY_OBJECT )
								->offsetGet( kTAG_NID );
			$results[ $key ][ 'Path' ] = $path;
		}
		
		//
		// Set count.
		//
		$results[ $key ][ 'Path' ] = $value;
	}
print_r( $results );
}

//
// Catch exceptions.
//
catch( \Exception $error )
{
	echo( $error->xdebug_message );
}

echo( "\nDone!\n" );

?>
